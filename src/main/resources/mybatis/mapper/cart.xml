<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wck.mapper.CartMapper">

	<!-- cartMap declare and definition -->
	<!-- property : java variable, column = db variable -->
 	<resultMap type="com.wck.domain.CartVO" id="cartMap">
 		<result property="bName" column="BNAME"/>
 		<result property="pName" column="PNAME"/>
 		<result property="pCPrice" column="PCPRICE"/>
 		<result property="pCColorCode" column="PCCOLORCODE"/>
 		<result property="pSize" column="PSIZE"/>
 		<result property="pQuantity" column="PQUANTITY"/>
 		<result property="like" column="LIKE"/>
 	</resultMap>

	<insert id="insertCart">
		INSERT INTO CART (MID, PSID, PQUANTITY, CDATE)
		VALUES (#{mId}, #{pSId}, #{pQuantity}, SYSDATE)
	</insert>
	
	<select id="countCart" resultType="int">
		SELECT PQUANTITY FROM CART WHERE MID = #{mId} AND PSID = #{pSId}
		UNION ALL
		SELECT 0 AS PQUANTITY FROM DUAL WHERE NOT EXISTS (SELECT * FROM CART WHERE MID = #{mId} AND PSID = #{pSId})
	</select>
	
	<select id="readCart" resultMap="cartMap">
		SELECT pc2.BNAME, pc2.PNAME, pc1.PCPRICE, pc1.PCCOLORCODE, ps.PSIZE, c.PQUANTITY,
			CASE WHEN EXISTS (SELECT 1 FROM LIKES l WHERE l.MID = c.MID AND pc1.PID = l.PID) THEN 1 ELSE 0 END AS "LIKE"
		FROM PRODUCT_STOCK ps, PRODUCT_COLOR pc1, PRODUCT_COMMON pc2, CART c  
		WHERE ps.PCID = pc1.PCID AND pc1.PID = pc2.PID AND ps.PSID = c.PSID AND c.MID = #{mId}
		ORDER BY c.CDATE DESC
	</select>
	
	<update id="updateCart">
		UPDATE CART SET PQUANTITY = #{pQuantity}, CDATE = SYSDATE WHERE PSID = #{pSId} AND MID = #{mId}
	</update>
</mapper>