<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wck.mapper.ProductMapper">
	
	<resultMap type="productCommon" id="productCommonMap">
		<id property="pId" column="pId"/>
		<result property="pName" column="pname"/>
		<result property="pNote" column="pnote"/>
		<result property="pStatus" column="pstatus"/>
		<result property="bNo" column="bno"/>
		<result property="bName" column="bname" />
		<collection property="colors" resultMap="productColorMap"/>
	</resultMap>
	
	<resultMap type="productColor" id="productColorMap">
		<id property="pcId" column="pcid"/>
		<result property="pcImg1" column="pcimg1"/>
		<result property="pcImg2" column="pcimg2"/>
		<result property="pcImg3" column="pcimg3"/>
		<result property="pcChipImg" column="pcchipimg"/>
		<result property="pcColorCode" column="pccolorcode"/>
		<result property = "pcPrice" column="pcprice"/>
		<collection property="stocks" resultMap="productStockMap"/>
	</resultMap>
	
	<resultMap type="productStock" id="productStockMap">
		<id property="psId" column="psId"/>
		<result property="psStock" column="psStock"/>
		<result property="pSize" column="pSize"/>
	</resultMap>
	
	<select id="getLikeProductList" resultMap="productCommonMap">
            select rn,
				l.pid, p.pname, p.pnote, b.bno, p.pstatus,
				pc.pcid, pcimg1, pcimg2, pcimg3, pcchipimg, pccolorcode, pcprice,
				b.bname
			from(	
				select rownum rn, pid
				from(
					select pid
					from likes 
					where mid =#{mId}
					order by ltime desc
				) a
				<![CDATA[
				where rownum <= #{cri.currentPage} * #{cri.pageSize}
			) l
			inner join product_common p on (l.pid = p.pid)
			left join brand b on (p.bno = b.bno)
			inner join product_color pc on (pc.pid = p.pid)
            where rn > (#{cri.currentPage} - 1) * #{cri.pageSize}
            ]]>
	</select>
	
	<select id="getProductDetailByPid" resultMap="productCommonMap">
		select 
		    p.pid, p.pname, p.pnote, p.pstatus,
		    b.bno, b.bname,
		    pc.pcid, pc.pcimg1, pc.pcimg2, pc.pcimg3, pc.pcchipimg, pc.pccolorcode, pc.pcprice,
		    ps.psid, ps.psstock, ps.psize
		from product_common p
		inner join brand b on (b.bno = p.bno)
		left join product_color pc on (p.pid = pc.pid)
		left join product_stock ps on (ps.pcid = pc.pcid)
		where p.pid = #{pId}
	</select>
	

 	<resultMap type="product" id="productsMap">
 		<id property="PID" column="PID" />
 		<result property="PNAME" column="PNAME" />
  		<result property="BNAME" column="BNAME" />
   		<result property="PCPRICE" column="PNAME" />
		<collection property="PCCOLORINFO" resultMap="pcColorInfo">
  		</collection> 	
 	</resultMap>
 	
 	<resultMap type="detailProduct" id= "pcColorInfo">
 		<result property="PCID" column="PCID" />
 		<result property="PCCOLORCODE" column="PCCOLORCODE" />
 		<result property="PCIMG1" column="PCIMG1" />
 		<result property="PCCHIPIMG" column="PCCHIPIMG" />
 	</resultMap>
 	

	<select id="getProducts" resultMap = "productsMap">
		SELECT pcom.pid, pcolor.pcid, pcom.pname, pcom.bname, 
		pcolor.pcimg1, pcolor.pcprice,pcolor.pccolorcode, pcolor.pcchipimg
		FROM product_common pcom
		INNER JOIN product_category pcat
		ON pcom.pid = pcat.pid
		INNER JOIN category c
		<if test="gd != null">
			ON c.depth1name = #{gd}
			<if test=" sC!= null">
				AND ON c.depth2name = #{sC}
			</if>
			<if test=" tC!= null">
				AND ON c.depth3name = #{tC}
			</if>
		</if>
		INNER JOIN product_color pcolor
		ON pcolor.pid = pcom.pid
		GROUP BY pcom.pid, pcom.pname, pcom.bname, 
		pcolor.pcimg1, pcolor.pcprice, pcolor.pcid, pcolor.pccolorcode, pcolor.pcchipimg;
	</select>
	
	
	<select id="existLikeProduct" resultType="boolean">
		select count(*) from likes
		where mid = #{mId} and pid = #{pId}
	</select>
	
	<delete id="deleteLikeProduct">
		delete from likes
		where mid = #{mId} and pid = #{pId}
	</delete>
	
	<insert id="insertLikeProduct">
		insert into likes (pid, mid, ltime)
		values (#{pId}, #{mId}, TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF3'))
	</insert>
	
	<select id="getLikeProductCount" resultType="int">
		select count(*) from likes
		where mid = #{mId}
	</select>
	

</mapper>
